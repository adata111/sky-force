<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>My first three.js app</title>
		<style>
			body { margin: 0; }
		</style>
	</head>
	<body>
        <h4 id="time">
        </h4>
        
        <h4 id="score">
        </h4>
		<script src="js/three.js"></script>
		<script>
			// Our Javascript will go here.
            const start_time = Date.now()
            var elapsed_time = 0
            var score =0;
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );

            const renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize( window.innerWidth, window.innerHeight );
            document.body.appendChild( renderer.domElement );
            const geometry = new THREE.BoxGeometry(0.5,0.5,0.1);
            const material = new THREE.MeshLambertMaterial( { color: 0x00ff00 } );
            const missile_geometry = new THREE.ConeGeometry(0.1,0.2,16);
            const missile_material = new THREE.MeshLambertMaterial( { color: 0x770001 } );
            const star_geometry = new THREE.SphereGeometry(0.1);
            const star_material = new THREE.MeshPhongMaterial({color:0xffd700});
            const enemy_jet_geometry = new THREE.BoxGeometry(0.2,0.2,0.1);
            const enemy_jet_material = new THREE.MeshPhongMaterial({color:0xee0000});
            // console.log(geometry)
            const cube = new THREE.Mesh( geometry, material );
            // console.log(cube.geometry.isBufferGeometry)
            
            scene.add( cube );

            var missiles = [];
            function shootMissile(){
                console.log("shoot");
                var missile = new THREE.Mesh( missile_geometry, missile_material);
                // console.log(cube);
                missile.position.set(cube.position.x, cube.position.y+cube.geometry.parameters.height/2, cube.position.z);
                missile.rotation.x+=0.5
                missiles.push(missile);
                console.log(missiles.length)
                scene.add(missile)
            }
            var stars=[];
            function addStars(){
                console.log("adding stars")
                var star = new THREE.Mesh(star_geometry, star_material);
                star.position.set(-4+Math.random()*8,-4+Math.random()*8, cube.position.z);
                stars.push(star)
                scene.add(star);
            }
            
            var enemy_jets = []
            function addEnemyJets(){
                console.log("adding enemies")
                var enemy_jet = new THREE.Mesh()
                for(var i=0;i<3;i++){
                    enemy_jet = new THREE.Mesh(enemy_jet_geometry, enemy_jet_material)
                    enemy_jet.position.set((Math.random()-0.5)*(3), 4+i, cube.position.z)
                    enemy_jets.push(enemy_jet)
                    scene.add(enemy_jet)
                }
            }
            var loader = new THREE.TextureLoader();
            loader.crossOrigin = true
            //Space background is a large sphere
            var specmap = loader.load("https://s3-us-west-2.amazonaws.com/s.cdpn.io/96252/water-map-512.jpg");
            var spacetex = loader.load("https://s3-us-west-2.amazonaws.com/s.cdpn.io/96252/space.jpg", function(texture) {
                // this code makes the texture repeat
                texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set( 4, 4 );
                
                })
            // set the texture as the map for the material
            var mat = new THREE.MeshPhongMaterial( {map: spacetex} );
            var spacesphereGeo = new THREE.SphereGeometry(100,100,100);

            var spacesphere = new THREE.Mesh(spacesphereGeo,mat);
            
            //spacesphere needs to be double sided as the camera is within the spacesphere
            spacesphere.material.side = THREE.DoubleSide;
            
            scene.add(spacesphere);
            

            /* we need to add a light so we can see our cube - its almost
            as if we're turning on a lightbulb within the room */
            var light = new THREE.AmbientLight(0xFFFF00);
            /* position the light so it shines on the cube (x, y, z) */
            light.position.set(10, 0, 25);
            scene.add(light);

            //create two spotlights to illuminate the scene
            var spotLight = new THREE.SpotLight( 0xffffff ); 
            spotLight.position.set( -100, 200, -90 ); 
            spotLight.intensity = 2;
            scene.add( spotLight );

            var spotLight2 = new THREE.SpotLight( 0x5192e9 ); 
            spotLight2.position.set( 100, -200, 90 ); 
            spotLight2.intensity = 1.5;
            scene.add( spotLight2 );


            camera.position.z = 5;

            var xSpeed = 0.1;
            var ySpeed = 0.1;

            var enemy_jet_ySpeed = 0.01;

            var missile_speed = 0.05
            document.addEventListener("keydown", onDocumentKeyDown, false);
            function onDocumentKeyDown(event) {
                // console.log("hi");
                var keyCode = event.which;
                if (keyCode == 87) {
                    cube.position.y += ySpeed;
                } else if (keyCode == 83) {
                    cube.position.y -= ySpeed;
                } else if (keyCode == 65) {
                    cube.position.x -= xSpeed;
                } else if (keyCode == 68) {
                    cube.position.x += xSpeed;
                } else if (keyCode == 32) {
                    shootMissile();
                }
            };

            var missile_to_del=[]
            var i__ = 0;
            var star_to_del = []
            function star_plane_collision(){
                star_to_del=[]
                for(var i=0;i<stars.length;i++){
                    // stars[i].rotation.y+=0.01
                    if(stars[i].position.distanceTo(cube.position)<0.45){
                        // console.log(collisionResults[0].object.name);
                        // console.log(directionVector)
                        console.log("coll")
                        // console.log(collisionResults[0])
                        star_to_del.push(stars[i])
                        stars.splice(i,1)
                        score+=5;
                        // console.log(star_to_del)
                        break;
                        // collisionResults[0].object.material.transparent = true;
                        // collisionResults[0].object.material.opacity = 0.4;
                    }
                }
                // console.log(stars.length)
                for (var i=0 ; i<star_to_del.length;i++){
                    console.log("removing stars")
                    // console.log(star_to_del.length)
                    scene.remove(star_to_del[i])
                    // stars.splice(i,1)
                    console.log(stars.length)
                }
            }
            function missile_enemy_collision(){
                enemy_to_del=[]
                for(var i=0;i<missiles.length;i++){
                    for(var j=0;j<enemy_jets.length;j++){
                        // stars[i].rotation.y+=0.01
                        if(missiles[i].position.distanceTo(enemy_jets[j].position)<0.15){
                            console.log("coll enemy missile")
                            scene.remove(missiles[i])
                            scene.remove(enemy_jets[j])
                            // missiles[i].visible=false
                            // enemy_jets[j].visible=false
                            missiles.splice(i,1)
                            enemy_jets.splice(j,1)
                            score+=10
                            break;
                        }
                    }
                }
            }
            function plane_enemy_collision(){
                enemy_to_del=[]
                for(var j=0;j<enemy_jets.length;j++){
                    // stars[i].rotation.y+=0.01
                    if(cube.position.distanceTo(enemy_jets[j].position)<0.45){
                        console.log("coll enemy plane")
                        enemy_jets[j].visible=false
                        scene.remove(enemy_jets[j])
                        enemy_jets.splice(j,1)
                        score-=5
                        break;
                    }
                }
            }
            for(var i =0;i<5;i++){
                addStars()
            }
            var enemy_jet_cooldown = 15
            var flag = 1;   //changed to 1 at the start of every (enemy_jet_cooldown)th second and then changed back to zero
            function animate() {
                requestAnimationFrame( animate );
                // cube.rotation.x += 0.01;
                // cube.rotation.y += 0.01;    
                spacesphere.rotation.x -= 0.001;
                elapsed_time = Math.floor((Date.now()-start_time)/1000)
                document.getElementById("time").innerHTML = "Time: "+elapsed_time
                document.getElementById("score").innerHTML = "Score: "+score
                // console.log(clock.running)
                // spacesphere.position.y -= 0.1
                // if(spacesphere.position.y<-20){
                //     spacesphere.position.y=20;
                // }
                missile_to_del = []
                missiles.forEach(missile => {
                    missile.position.y += missile_speed;
                    if(missile.position.y>4 || !missile.visible){
                        missile_to_del.push(missile)
                    }
                });
                for(var i =0;i<missile_to_del.length;i++){
                    scene.remove(missile_to_del[i])
                    missiles.splice(i,1)
                }
                if(stars.length<3){
                    while(stars.length<5)
                        addStars();
                }
                if(elapsed_time%enemy_jet_cooldown==0 && flag){
                    addEnemyJets()
                    flag=0
                }
                if(elapsed_time%enemy_jet_cooldown==1)
                    flag=1
                enemy_jet_to_del = []
                enemy_jets.forEach(enemy_jet => {
                    enemy_jet.position.y -= enemy_jet_ySpeed
                    if(enemy_jet.position.y<-4 || !enemy_jet.visible){
                        // console.log((-window.innerHeight/2))
                        enemy_jet_to_del.push(enemy_jet)
                    }
                });
                for(var i =0;i<enemy_jet_to_del.length;i++){
                    scene.remove(enemy_jet_to_del[i])
                    enemy_jets.splice(i,1)
                }
                star_plane_collision();
                missile_enemy_collision();
                plane_enemy_collision();
                renderer.render( scene, camera );
            }
            animate();
            
		</script>
	</body>
</html>